<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Lobby</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
</head>
<body>
    <h1>Game Lobby</h1>

    <p><strong>Game Code:</strong> <span id="gameCode" th:text="${gameCode}"></span></p>
    <p>Waiting for the host to start the game...</p>

    <!-- <h2>Players:</h2>
    <ul id="playerList">
       
        <li th:each="player : ${players}" th:text="${player}"></li>
    </ul> -->

    <p id="statusMessage" style="color: green;"></p>

    <script th:inline="javascript">
        const gameCode = /*[[${gameCode}]]*/ '';  // Ensure this is set dynamically
        console.log("Game Code:", gameCode); // Verify if it's being injected correctly
        const playerName = /*[[${playerName}]]*/ ''; // Same for playerName
        console.log("Player Name:", playerName);  
        const socket = new SockJS('/game');
        const stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {
            // Subscribe to updates for this lobby
            
            stompClient.subscribe(`/topic/lobby/${gameCode}`, function (message) {
                const playerList = document.getElementById("playerList");
                const playerData = JSON.parse(message.body);
                // console.log(playerData);
                // Clear the current player list and update dynamically
                playerList.innerHTML = "";
                playerData.players.forEach(player => {
                    const newPlayer = document.createElement("li");
                    newPlayer.textContent = player;
                    playerList.appendChild(newPlayer); 
                });
               
            });

            // Notify the server that this player has joined
            console.log("connected here");
            console.log(playerName);
            stompClient.send(`/app/joinLobby/${gameCode}`, {},playerName);
            stompClient.subscribe(`/topic/gameStart/${gameCode}`, function (message) {
                // console.log(message.body);
                // Redirect to the game start page when the host starts the game
                window.location.href = `/player/gamestart/${gameCode}`;
            });
            
        });
        
    </script>
</body>
</html>

