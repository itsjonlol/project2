<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Host Game Lobby</title>
    <!-- Use a CDN for SockJS and STOMP if WebJars is not working -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>

</head>
<body>
    <h1>Host Game Lobby</h1>

    <p><strong>Game Code:</strong> <span id="gameCode" th:text="${gameCode}"></span></p>
    <p>Share this code with your friends so they can join the game!</p>

    <h2>Players:</h2>
    <ul id="playerList">
        <!-- <li th:each="player : ${players}" th:text="${player}"></li> -->
        <!-- WebSocket will update this dynamically -->
    </ul>
    <!-- <button id="getPlayers" >Get Players</button> -->
    <button id="startGame" disabled>Start Game</button>

    <!-- Load SockJS and STOMP libraries from CDN -->
    
    
    <script th:inline="javascript">
        
        const gameCode = /*[[${gameCode}]]*/ '';  // Ensure this is set dynamically
        console.log("Game Code:", gameCode); // Verify if it's being injected correctly
        const playerName = "broooo"; // Same for playerName
        console.log("Player Name:", playerName);  
        const socket = new SockJS('/game');
        const stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {
            // Subscribe to updates for this lobby (for host as well)
            stompClient.subscribe(`/topic/lobby/${gameCode}`, function (message) {
                console.log("Connected to WebSocket");
                const playerList = document.getElementById("playerList");
                const playerData = JSON.parse(message.body);
                
                

                // Clear the current player list and update dynamically
                playerList.innerHTML = "";
                playerData.players.forEach(player => {
                    const newPlayer = document.createElement("li");
                    newPlayer.textContent = player;
                    playerList.appendChild(newPlayer);
                });

                // Enable the Start Game button if at least 2 players are present
                const startButton = document.getElementById("startGame");
                startButton.disabled = playerData.players.length < 2;
                console.log("connected here");
                console.log(playerName);
                
            });

            // Notify the server that the host is also in the lobby (just like other players)
            // stompClient.send(`/app/joinLobby/${gameCode}`, {}, playerName);
           
        });
        // document.getElementById("getPlayers").addEventListener("click",function() {
        //     console.log("hmm1");
        //     console.log(`/app/joinLobby/${gameCode}`);
        //     console.log("hmm2");
        //     stompClient.send(`/app/joinLobby/${gameCode}`, {}, playerName);
        //     const notifications = document.getElementById('playerList');
        //     const notification = document.createElement('p');
        //     notification.textContent = playerName;
        //     notifications.appendChild(notification);
            
        // });

        // Host clicks the Start Game button
        document.getElementById("startGame").addEventListener("click", function () {
            stompClient.send(`/app/startGame/${gameCode}`, {});
            window.location.href = `/host/gamestart/${gameCode}`;
        });
    </script>
</body>
</html>





